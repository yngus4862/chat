## 1. 요구사항 해석(가정 포함)

- **사용자/트래픽(주어짐):** 총 20명, 동접 20, 메시지 500/일, 첨부 1GB/일(최대 300MB)

- **실시간 목표(가정):**
  
  - 사내망/VPN 기준 **전달 지연 P95 300ms~1s**, 푸시(모바일) **수 초 이내**

- **신뢰성(가정):**
  
  - 메시지 전송은 **최소 1회(at-least-once)** + **중복방지(idempotency)** 로 “정확히 1번처럼 보이게”
  
  - **채팅방 단위 순서 보장**(서버가 최종 시퀀싱)

- **인증/조직(주어짐):** LDAP/SSO/사번/OAuth2 혼용 → **중앙 IdP(권고: Keycloak)** 로 통합(아래 비교)

- **파일 저장:** DB에는 메타데이터/권한/참조만, 본문은 객체저장소(권고: MinIO)

- **관측성(주어짐):** Prometheus + Grafana + Elastic(로그/검색)

---

## 2. 아키텍처(텍스트 다이어그램)

```
[Windows C#]      [Android Java]        [iOS Swift]
     |                 |                    |
     |  HTTPS (REST)   |   WSS (Realtime)   |  Push(APNs/FCM/Windows)
     v                 v                    v
                 ┌─────────────────────────────┐
                 │   Reverse Proxy (Nginx)     │  TLS 종료, 라우팅, 업로드 제한
                 └──────────────┬──────────────┘
                                |
        ┌───────────────────────┼─────────────────────────┐
        |                       |                         |
        v                       v                         v
┌───────────────┐     ┌────────────────┐        ┌─────────────────┐
│ Auth/IdP       │     │ Chat API       │        │ Realtime Gateway │
│ (Keycloak)     │<--->│ (REST)         │<------>│ (WebSocket/Hub)  │
└───────┬────────┘     └───────┬────────┘        └───────┬─────────┘
        |                      |                           |
        |                      |                           |
        v                      v                           v
┌───────────────┐     ┌────────────────┐        ┌─────────────────┐
│ Org/Profile    │     │ Message Store   │        │ Notification Svc │
│ Service        │     │ (DB)            │        │ (Push + Badge)   │
└───────┬────────┘     └───────┬────────┘        └───────┬─────────┘
        |                      |                           |
        v                      v                           v
┌───────────────┐     ┌────────────────┐        ┌─────────────────┐
│ Search Indexer │<----│ Outbox/EventBus │-----> │ Link Preview     │
│ (Elastic)      │     │ (Redis/NATS)    │       │ Worker + SSRF방어│
└───────┬────────┘     └───────┬────────┘        └───────┬─────────┘
        |                      |                           |
        v                      v                           v
   [Elastic]               [Redis]                      [MinIO + ClamAV]
                           캐시/세션                     파일/이미지/썸네일
                                |
                                v
                           [PostgreSQL]
```

> **권고 구조:** 초기엔 “모듈형 모놀리스(단일 Chat 서버 + 내부 모듈)”로 시작하고, 나중에 Notification/Search/Preview를 분리하기 쉽게 **Outbox + 이벤트**를 깔아둡니다.

---

## 3. 스택 비교표 + 권고안

### 후보 A (권고): **.NET + SignalR** 중심

| 항목            | 선택                                         |
| ------------- | ------------------------------------------ |
| REST/Realtime | ASP.NET Core + **SignalR(WebSocket)**      |
| DB            | PostgreSQL                                 |
| 캐시/이벤트        | Redis(캐시+pubsub) 또는 NATS(선택)               |
| 검색            | Elastic (메시지/파일 메타)                        |
| 파일            | MinIO(S3 호환) + presigned URL               |
| 배포            | Docker Compose (Ubuntu 24.04 컨테이너) + Nginx |
| 장점            | C# 클라이언트/윈도우 친화, 실시간 구현 난이도 낮음, 성숙한 생태계    |
| 단점            | 서버가 .NET 중심(팀 스킬셋 영향)                      |
| 운영 난이도        | 중                                          |
| 비용            | 오픈소스 위주(낮음)                                |

### 후보 B: **Node.js(TypeScript) + ws(Socket.IO)**

| 장점 | 빠른 개발, 생태계 풍부 |  
| 단점 | 실시간/상태/재연결/순서보장 설계가 팀 숙련도에 크게 의존 |  
| 운영 | 중 |

### 후보 C: **Go + WebSocket + gRPC(내부)**

| 장점 | 성능/단순 배포, 서버 자원 효율 |  
| 단점 | 기능 속도(생산성)와 클라이언트 생태계 도구는 팀에 따라 부담 |  
| 운영 | 중~상 |

✅ **최종 권고:** **후보 A(.NET + SignalR + Postgres + Redis + MinIO + Elastic)**  
규모(20명)에서 “가장 적게 망가지고” 요구 기능을 빠르게 채웁니다. 확장도 SignalR backplane/Redis, Outbox 이벤트로 단계적 분리가 쉽습니다.

---

## 4. 데이터 모델 표(ERD 대체)

> 타입 표기는 개념적입니다. (PostgreSQL 기준: uuid, bigint, timestamptz, jsonb 등)

### 핵심 테이블

| Table       | PK                    | 주요 FK            | 중요 컬럼                                | 인덱스(권고)                   | 비고             |
| ----------- | --------------------- | ---------------- | ------------------------------------ | ------------------------- | -------------- |
| users       | user_id(uuid)         |                  | employee_no, login_id, status        | (login_id), (employee_no) | IdP subject 매핑 |
| profiles    | user_id               | users.user_id    | name, title, phone, email, photo_key | (name)                    | 프로필            |
| org_units   | org_unit_id           |                  | name, parent_id                      | (parent_id), (name)       | 조직도            |
| org_members | (org_unit_id,user_id) | org_units, users | role_in_org                          | (user_id)                 | 겸직 가능          |

### 채팅방/멤버

| Table        | PK                | 주요 FK             | 중요 컬럼                                                                 | 인덱스(권고)                                   | 비고                          |
| ------------ | ----------------- | ----------------- | --------------------------------------------------------------------- | ----------------------------------------- | --------------------------- |
| chat_rooms   | room_id(uuid)     |                   | type(DM/GROUP), name, created_by, deleted_at                          | (type), (deleted_at)                      | DM은 유니크 제약 추가(아래)           |
| room_members | (room_id,user_id) | chat_rooms, users | is_admin, joined_at, left_at, muted, pinned, **last_read_message_id** | (user_id), (room_id,last_read_message_id) | 읽음 기준안(b)용                  |
| room_dm_keys | dm_key(text)      |                   | room_id                                                               | UNIQUE(dm_key)                            | DM 중복 생성 방지(예: “u1:u2” 정렬키) |

### 메시지/읽음/핀/멘션

| Table              | PK                   | 주요 FK               | 중요 컬럼                                                                            | 인덱스(권고)                                      | 비고                                                |
| ------------------ | -------------------- | ------------------- | -------------------------------------------------------------------------------- | -------------------------------------------- | ------------------------------------------------- |
| messages           | message_id(bigint)   | room_id, sender_id  | client_msg_id(uuid), type(TEXT/FILE/NOTICE/POLL/…), body(text/jsonb), created_at | (room_id,message_id), (sender_id,created_at) | **idempotency**: UNIQUE(sender_id, client_msg_id) |
| message_mentions   | (message_id,user_id) | messages, users     |                                                                                  | (user_id,message_id)                         | @멘션                                               |
| pins               | pin_id(uuid)         | room_id, message_id | pinned_by, pinned_at                                                             | (room_id,pinned_at desc)                     | 상단고정(공지)                                          |
| read_receipts (선택) | (message_id,user_id) | messages, users     | read_at                                                                          | (user_id,read_at)                            | 읽음 방식(a)용(옵션)                                     |

### 첨부/파일/링크 프리뷰

| Table         | PK                  | 주요 FK                   | 중요 컬럼                                                              | 인덱스          | 비고           |
| ------------- | ------------------- | ----------------------- | ------------------------------------------------------------------ | ------------ | ------------ |
| attachments   | attachment_id(uuid) | message_id, uploader_id | storage_key, filename, size, mime, sha256, virus_status, thumb_key | (message_id) | 본문은 MinIO    |
| links         | link_id(uuid)       | message_id              | url, domain, preview_status                                        | (domain)     | 링크 메타        |
| link_previews | link_id             | links.link_id           | title, description, image_url, fetched_at, error_code              | (fetched_at) | SSRF 방어 후 수집 |

### 투표(채팅 내) vs 설문(별도)

| Table        | PK                | 주요 FK               | 중요 컬럼                             | 인덱스                 | 비고                                 |
| ------------ | ----------------- | ------------------- | --------------------------------- | ------------------- | ---------------------------------- |
| polls        | poll_id(uuid)     | room_id, message_id | question, is_anonymous, closes_at | (room_id)           | “투표”                               |
| poll_options | option_id(uuid)   | poll_id             | text                              | (poll_id)           |                                    |
| poll_votes   | (poll_id,user_id) | polls, users        | option_id, voted_at               | (poll_id,option_id) | 복수선택이면 (poll_id,user_id,option_id) |

| Table            | PK                | 주요 FK                                | 중요 컬럼                                                               | 인덱스                      | 비고                        |
| ---------------- | ----------------- | ------------------------------------ | ------------------------------------------------------------------- | ------------------------ | ------------------------- |
| surveys          | survey_id(uuid)   | created_by                           | title, is_anonymous, opens_at, closes_at, target_org_unit(optional) | (closes_at)              | “설문”                      |
| survey_questions | question_id(uuid) | survey_id                            | type(SINGLE/MULTI/TEXT/SCALE), prompt, required, order_no           | (survey_id,order_no)     |                           |
| survey_choices   | choice_id(uuid)   | question_id                          | text, order_no                                                      | (question_id,order_no)   | 객관식                       |
| survey_responses | response_id(uuid) | survey_id, user_id(nullable if anon) | submitted_at                                                        | (survey_id,submitted_at) | 익명이면 user_id null + 난수 토큰 |
| survey_answers   | answer_id(uuid)   | response_id, question_id             | choice_id(nullable), text_answer(nullable), scale_value(nullable)   | (question_id)            | 통계                        |

### 알림/감사로그

| Table         | PK               | 주요 FK         | 중요 컬럼                                                             | 인덱스                                        | 비고    |
| ------------- | ---------------- | ------------- | ----------------------------------------------------------------- | ------------------------------------------ | ----- |
| push_tokens   | token_id(uuid)   | user_id       | platform, token, last_seen_at, enabled                            | (user_id,platform), UNIQUE(platform,token) | 토큰관리  |
| notifications | noti_id(uuid)    | user_id       | type, payload(jsonb), sent_at, read_at                            | (user_id,read_at)                          | 뱃지 계산 |
| audit_logs    | audit_id(bigint) | actor_user_id | action, target_type, target_id, ip, ua, created_at, detail(jsonb) | (created_at), (action)                     | 감사로그  |

---

## 5. API(REST) 표 + 실시간 이벤트 표

### REST API (요약)

| 영역       | Method | Endpoint                                  | 설명                  |
| -------- | ------ | ----------------------------------------- | ------------------- |
| Auth     | GET    | /me                                       | 내 프로필/권한            |
| Org      | GET    | /org/tree                                 | 조직도 트리              |
| Users    | GET    | /users?query=                             | 사용자 검색              |
| Rooms    | GET    | /rooms                                    | 내 채팅방 목록(고정/뮤트 포함)  |
| Rooms    | POST   | /rooms                                    | 방 생성(DM/그룹)         |
| Rooms    | PATCH  | /rooms/{roomId}                           | 방 이름 등 변경           |
| Members  | POST   | /rooms/{roomId}/members                   | 초대                  |
| Members  | DELETE | /rooms/{roomId}/members/{userId}          | 퇴출                  |
| Members  | POST   | /rooms/{roomId}/leave                     | 나가기                 |
| Messages | GET    | /rooms/{roomId}/messages?beforeId=&limit= | 페이징 조회              |
| Messages | POST   | /rooms/{roomId}/messages                  | 메시지 전송(idempotency) |
| Reads    | POST   | /rooms/{roomId}/read                      | 마지막 읽음 갱신           |
| Pins     | POST   | /rooms/{roomId}/pins                      | 공지/상단고정             |
| Search   | GET    | /search?q=&type=                          | 통합 검색               |
| Files    | POST   | /files/init                               | 업로드 세션 생성(프리사인/청크)  |
| Files    | POST   | /files/complete                           | 업로드 완료/검증           |
| Surveys  | POST   | /surveys                                  | 설문 생성               |
| Surveys  | POST   | /surveys/{id}/submit                      | 응답 제출               |
| Admin    | GET    | /audit?from=&to=                          | 감사로그 조회             |

### 메시지 전송 요청/응답 예시

```json
POST /rooms/{roomId}/messages
{
  "clientMsgId": "b7f2f8a0-2b5c-4c4a-9d18-2f6bde5b7f18",
  "type": "TEXT",
  "text": "회의 10분 늦습니다",
  "mentions": ["user-uuid-1"],
  "attachments": []
}
```

```json
200 OK
{
  "messageId": 912345,
  "roomId": "room-uuid",
  "senderId": "user-uuid",
  "createdAt": "2026-02-19T10:11:12Z"
}
```

### 에러 코드 규칙(예)

| HTTP | code              | 의미              |
| ---- | ----------------- | --------------- |
| 400  | INVALID_ARGUMENT  | 파라미터 오류         |
| 401  | UNAUTHENTICATED   | 토큰 만료/없음        |
| 403  | FORBIDDEN         | 권한 없음(방 접근/관리자) |
| 404  | NOT_FOUND         | 리소스 없음          |
| 409  | CONFLICT          | 중복(DM 방/아이템포턴시) |
| 413  | PAYLOAD_TOO_LARGE | 파일 크기 초과        |
| 429  | RATE_LIMITED      | 남용 방지           |
| 500  | INTERNAL          | 서버 오류           |

### 실시간 이벤트(WebSocket/SignalR) 타입

| Event                | Payload 핵심                        |
| -------------------- | --------------------------------- |
| ROOM_CREATED         | room, members                     |
| ROOM_UPDATED         | room patch                        |
| MEMBER_INVITED       | roomId, user                      |
| MEMBER_REMOVED       | roomId, userId                    |
| MESSAGE_CREATED      | message(본문/첨부/링크요약)               |
| MESSAGE_UPDATED      | (선택) 수정 기능 넣을 때                   |
| READ_UPDATED         | roomId, userId, lastReadMessageId |
| PIN_UPDATED          | roomId, pins                      |
| POLL_UPDATED         | pollId, counts                    |
| SURVEY_CREATED       | survey summary(대상자 알림)            |
| NOTI_BADGE_UPDATED   | userId, unreadCount               |
| PRESENCE_UPDATED(선택) | userId, online/offline            |

---

## 6. 읽음/미읽음 설계(2안 비교)

### (a) **메시지별 per-user 읽음 테이블**: `read_receipts(message_id, user_id)`

- 장점
  
  - “이 메시지를 누가 읽었는지”가 **정확하고 즉시 조회**
  
  - 감사/컴플라이언스 성격 요구가 강할 때 유리

- 단점
  
  - 그룹이 커질수록 쓰기 폭발(메시지×멤버)
  
  - 동접/재접속에서 업데이트 트래픽 증가

- 성능(20명 규모)
  
  - 지금은 충분히 가능하나, 구조가 무거워짐

### (b) **room_members.last_read_message_id 기반(권고)**

- 방식
  
  - 사용자가 방을 열거나 스크롤이 “읽음 기준”을 넘으면:
    
    - `room_members.last_read_message_id = X` 업데이트
  
  - 특정 메시지의 “안읽은 사람”은 서버가:
    
    - `room_members(last_read_message_id < message_id)` 조건으로 계산

- 장점
  
  - 쓰기량이 **사용자 행동 단위**로 작음
  
  - 대규모로 커져도 유지 가능

- 단점
  
  - “메시지별 읽음 시각”은 직접 저장되지 않음(필요 시 (a) 부분 도입)

✅ **선택(권고): (b)**  
요구사항(“안읽은 사람 표시”)은 **계산으로 충분히 충족**합니다. 필요해지면 (a)를 “옵션(감사 목적)”으로 붙이는 하이브리드도 가능.

---

## 7. 파일/링크/이미지 설계

### 파일 업로드/다운로드(권고 흐름)

1. 클라이언트 `POST /files/init`
- 서버가 권한 체크 후 **MinIO presigned URL** 발급

- 대용량(300MB) 대비:
  
  - **멀티파트 업로드(S3 multipart)** 또는 **tus(Resumable)** 중 택1
2. 클라이언트가 MinIO로 직접 업로드

3. `POST /files/complete`
- 서버가 size/sha256 검증, `attachments`에 메타 저장
4. 메시지 전송 시 attachment_id 참조

**다운로드**

- 서버가 접근권한 체크 후 **짧은 TTL presigned GET URL** 발급(또는 프록시 스트리밍)

### 바이러스 스캔(옵션이지만 강권)

- 업로드 완료 이벤트 → Worker(ClamAV) 스캔

- `attachments.virus_status = CLEAN/INFECTED/PENDING`

- INFECTED면 다운로드 차단 + 감사로그 기록

### 이미지 미리보기/썸네일

- Worker가 썸네일 생성 후 `thumb_key` 저장

- 클라이언트는 원본/썸네일 선택 로드

### “적절한 실행 프로그램으로 열기”(클라이언트 설계)

- 첨부 메타: `mime`, `filename`, `downloadUrl`

- Windows(C#): OS 기본 연결로 열기(예: `Process.Start` + ShellExecute)

- Android: Intent + FileProvider

- iOS: QuickLook(QLPreviewController) / UIDocumentInteraction

### 링크 미리보기(서버/클라이언트 역할 분담)

- **서버가 미리보기 수집(권고)**: 모든 클라이언트에 동일 UX, 메타 캐시 가능

- SSRF 방어(필수)
  
  - DNS 리졸브 결과가 **사설/링크로컬/메타데이터 IP 대역**이면 차단
  
  - 리다이렉트 횟수 제한, 타임아웃(예: 2s), 최대 바이트 제한(예: 512KB)
  
  - User-Agent 고정, HTML 파싱은 안전 라이브러리 사용
  
  - 결과는 `link_previews`에 저장(실패도 캐시: error_code)

---

## 8. 푸시 알림 설계(플랫폼별)

### 공통 원칙

- “알림 끄기(방 단위)”는 `room_members.muted`로 처리

- 뱃지/미확인 카운트는:
  
  - 방별 unread 계산 + 사용자별 합산(서버가 계산해 내려줌)

- 토큰은 `push_tokens`로 관리(활성/최근접속/비활성)

### Android (FCM)

- 백그라운드/오프라인: FCM 데이터 메시지 + 알림 채널

- 딥링크: roomId/messageId 포함

- 토큰 갱신 이벤트 처리 필수

### iOS (APNs)

- 백그라운드: APNs + content-available(필요 시)

- 알림 그룹핑(thread-id = roomId)

- 배지: 서버가 숫자 계산해 payload에 포함

### Windows

- 현실적인 선택지 2개
  
  1. **Win32/WPF/WinUI(비스토어 배포)**: “진짜 푸시”는 제약이 많음 → **앱 온라인이면 WebSocket 알림 + 토스트**, 오프라인 푸시는 MVP에서 제외(권고)
  
  2. 스토어/패키징 가능하면: **WNS(Windows Push Notification Services)** 연동

- ✅ 권고(MVP): **Windows는 실시간 연결 기반 알림**, 모바일만 푸시 우선 구현

---

## 9. 클라이언트 구조(플랫폼별)

### Windows(C#) — MVVM

- UI: WPF 또는 WinUI 3 (팀/배포 방식에 따라)

- 레이어
  
  - `Presentation(View/ViewModel)`
  
  - `Domain(UseCases)`
  
  - `Data(ApiClient, WebSocketClient, LocalDb)`

- 로컬 DB: **SQLite**
  
  - rooms/messages/attachments 캐시 + outbox(오프라인 큐)

- 동기화
  
  - 로그인 후: `/rooms` → 각 방 최신 메시지 커서 동기화
  
  - WebSocket 재연결 시: “마지막 수신 messageId” 기준 gap fetch

- 파일 열기: OS 기본 앱 연동

### Android(Java) — MVVM

- UI: Activity/Fragment + ViewModel

- 네트워크: Retrofit/OkHttp + WebSocket(OkHttp)

- 로컬: Room(DB) + Paging3(가능하면)

- 백그라운드: WorkManager(재전송/동기화/업로드 재개)

### iOS(Swift)

- UI 선택(권고): **SwiftUI + Combine** (레거시/팀 사정이면 UIKit)

- 네트워크: URLSession + `URLSessionWebSocketTask`

- 로컬: CoreData 또는 SQLite(단순성은 SQLite 선호)

- 백그라운드: BackgroundTasks(제한 내) + APNs 중심

---

## 10. 보안/권한/감사로그

### TLS/전송 보안

- 외부/내부 모두 **TLS 필수**

- Nginx에서 TLS 종료 + 내부 서비스는 Docker 네트워크로 격리

### 인증/SSO/LDAP 혼용 해결(권고 2안)

- **안1(권고): Keycloak**
  
  - LDAP 연동 + OIDC/OAuth2 제공
  
  - 클라이언트는 OIDC 로그인 → 서버는 JWT 검증

- 안2: 서버 내 커스텀 인증(비추천)
  
  - 장기적으로 운영/보안 부채 급증

### 권한 모델(RBAC)

- 전역 역할: `SYSTEM_ADMIN`, `AUDITOR`, `USER`

- 방 역할: `ROOM_ADMIN`, `MEMBER`

- 체크 포인트
  
  - 방 관리(이름/초대/퇴출/삭제) 권한
  
  - 파일 다운로드 권한(방 멤버 + 메시지 접근)

### 감사로그(Audit)

- 누가/언제/무엇을:
  
  - 로그인, 방 생성/삭제, 멤버 초대/퇴출, 파일 다운로드, 권한 변경, 설문 생성/열람 등

- 저장
  
  - DB `audit_logs` + Elastic로 복제(검색/대시보드)

---

## 11. 배포/운영/모니터링 런북 (Windows Docker 서버 기준)

### 컨테이너 구성(Compose 권고)

- `nginx` (443)

- `chat-api` (.NET)

- `realtime-gateway` (SignalR 동일 프로세스로 합쳐도 됨)

- `postgres`

- `redis`

- `minio`

- `keycloak`

- `elastic` (+ kibana 선택)

- `prometheus`, `grafana`, `node-exporter`, `cadvisor`

- `link-preview-worker`, `scanner-worker(clamav)` (옵션)

### 역프록시 선택

- IIS vs Nginx vs Apache 중 **Nginx 권고**
  
  - WebSocket, 업로드 제한/버퍼링 제어, 설정 단순

### 인증서/키 관리

- 사내 CA 또는 공인 인증서

- Windows 인증서 저장소 + DPAPI 요구사항은:
  
  - **(권고) “서버 비밀(클라이언트 푸시 키 등)”을 Windows 쪽에서 DPAPI로 암호화한 파일로 보관**
  
  - 컨테이너에는 런타임에 마운트(읽기전용) 또는 시작 스크립트로 주입

### 방화벽/포트

- 외부 노출 최소:
  
  - 443만 공개(권고)
  
  - 내부는 Docker 네트워크

### 백업/복구(RTO 1h, RPO 15m)

- PostgreSQL
  
  - **WAL 아카이빙**(15분 이내 복구점) + 주기적 base backup

- MinIO
  
  - 버킷 버저닝 + 주기적 스냅샷/복제(가능하면)

- Elastic
  
  - snapshot repository(파일시스템/NFS 등)

### 배포/마이그레이션

- DB 마이그레이션: Flyway/Liquibase/EF migrations 중 택1(팀 스택)

- 롤링 업데이트(20명 규모 MVP)
  
  - “짧은 점검 배포”로 시작 → 나중에 블루/그린

### 관측성

- 로그: 구조화 JSON 로그 → Elastic

- 메트릭: Prometheus + Grafana

- 알람: Alertmanager (DB down, WS 연결수 급감, 업로드 실패율, 5xx 증가)

### 테스트 계획

- 부하: k6(REST/WS)로 동접 20~50 시뮬

- 장애: DB 재시작/Redis down 시 재연결/재전송 검증

- 보안: 링크프리뷰 SSRF 테스트, 파일 업로드 악성 확장자, 권한 우회 테스트

---

## 12. MVP 로드맵(주차별) + 리스크

### 9~12주 MVP (권고: 10주 플랜)

| 주차  | 목표                                | DoD(완료 기준)                     |
| --- | --------------------------------- | ------------------------------ |
| 1   | 스캐폴딩/CI/Compose/기본 인증             | 로컬에서 Keycloak 로그인, /me 동작      |
| 2   | 조직도/프로필/사용자 검색                    | org tree, 프로필 CRUD, 검색         |
| 3   | 채팅방(DM/그룹) CRUD + 멤버관리            | 초대/퇴출/나가기/관리자 권한               |
| 4   | 메시지(TEXT) REST + WebSocket 브로드캐스트 | 전송/수신/재연결 시 gap fetch          |
| 5   | 읽음/미읽음(안(b)) + 방 고정/알림끄기          | unread 계산, pinned/muted 반영     |
| 6   | 파일 업로드(프리사인) + 다운로드 권한            | 300MB 업로드, 권한 체크, 메타 저장        |
| 7   | 이미지 미리보기/썸네일 + 링크 프리뷰(SSRF 방어)    | 프리뷰 캐시, 실패 캐시                  |
| 8   | 검색(Elastic) + 인덱싱 파이프라인(Outbox)   | 메시지/파일 메타 검색                   |
| 9   | 투표(채팅 내) + 설문(별도)                 | 익명 옵션 포함, 통계 조회                |
| 10  | 푸시(Android/iOS) + 운영대시보드/백업       | FCM/APNs, Grafana 대시보드, 백업 리허설 |

### 이후 고도화

- Windows 오프라인 푸시(WNS) 또는 패키징 전략 확정

- 메시지 편집/삭제, 보관/내보내기(eDiscovery 유사)

- 멀티 서버 수평 확장(WS 스티키/백플레인), 읽음/검색 최적화

### 주요 리스크 & 완화

- **링크 프리뷰 SSRF/내부망 접근 위험** → 강력한 IP 대역 차단 + 타임아웃/리다이렉트 제한 + 결과 캐시

- **파일 악성코드/랜섬웨어 경로** → ClamAV 스캔 + 다운로드 차단 + 감사로그

- **재연결/중복 메시지** → `clientMsgId` 아이템포턴시 + 서버 ACK + outbox 큐

- **혼용 인증(LDAP/SSO/OAuth2) 복잡도** → Keycloak로 중앙화(초기에 고정)

---

## 품질 체크리스트(Checklist)

- 기능 요구사항 7개 카테고리 모두 반영 ✅

- 읽음/미읽음이 그룹채팅에서도 성능적으로 설명됨 ✅

- 실시간 이벤트 타입/페이로드 정의됨 ✅

- 파일/링크 프리뷰 보안(SSRF 등) 고려됨 ✅

- 푸시 알림이 플랫폼별로 현실적인 제약을 반영함 ✅

- 운영(로그/모니터링/백업/복구/배포) 포함 ✅

- MVP 범위가 “구현 가능한 단위”로 쪼개져 있음 ✅
